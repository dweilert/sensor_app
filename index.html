<!DOCTYPE html>
<html lang="en">

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MMPOAII</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        table {
            border-collapse: collapse;
        }

        td,
        th {
            border-left: 1px solid #bbb;
            border-right: 1px solid #bbb;
            border-bottom: 1px solid #555;
            border-top: 1px solid #555;
        }
    </style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
    <div class="container">
        <header style="background-color: #99f; color: #fff; "
            class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-1 border-bottom">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <span class="fs-5" style="color: #fff;">&nbsp;&nbsp;MMPOAII Sewage Monitor</span>
                <span class="fs-6" style="color: #fff;">&nbsp;&nbsp;(Press button for data)</span>
            </a>

            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-sm btn-secondary me-2" onclick="getData('p')">Pump
                    data</button>
                <button type="button" class="btn btn-sm btn-secondary me-4" onclick="getData('m')">SMS
                    data</button>
            </div>
        </header>

        <div id="outputTable">
            <!-- Data is inserted here -->
        </div>

        <!-- ==================================== -->
        <!-- Message Modal section                -->
        <!-- ==================================== -->
        <div class="modal fade" id="messageModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: #99f; ">
                        <h6 class="modal-title" style="font-size: 100%; color: #fff;">Pump Run
                            Information</h6>
                    </div>
                    <div class="modal-body docBackground">
                        <div id="messageBody" style="font-size: 80%;">
                            <!-- Data is inserted here -->
                        </div>
                    </div>
                    <div class="modal-footer" style="font-size: 80%;">
                        <button onclick="closeModal()" type="button" class="btn btn-sm btn-outline-secondary"
                            data-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google charts -->
    <div id="gauges_div" style="display: none; margin: 45px; font-size: larger; font-weight: bold ;">
        <span id="gaugeDate">Maximum Amps</span>
        <div id="chart_div" style="width: 250px;  font-weight: normal"></div>
        <div id="gaugeEntries" style="margin-top: 10px; font-size: 80%; font-weight: normal">
            <span id="entryA">Pump A high amps at: </span>
            <br>
            <span id="entryB">Pump B high amps at: </span>
        </div>
    </div>

    <div id="infoData_div" style="display: none; margin: 45px; font-size: larger; font-weight: bold ;">Info Data
        <div id="info_div" style="width: 100%;  font-weight: normal"></div>
    </div>

    <div id="run_div" style="display: none; margin: 45px; font-size: larger; font-weight: bold ;">
        Pump run times by day&nbsp;&nbsp;
        <span style="font-weight: normal; font-size: 60%;">(display area is scrollable)</span>
        <div id="run_time" style="height: 450px;"></div>
    </div>

    <!-- Scripts to populate the UI and retirieve data-->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous">
        </script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
        </script>

    <script>
        let pumpUsed = {};
        let ampsUsed = {};
        let energyUsed = {};
        let timelineUsed = {};
        let havePumpData = false;
        let pumpA_amps_high = 0;
        let pumpB_amps_high = 0;
        let pumpA_amps_entry = '';
        let pumpB_amps_entry = '';
        let infoData;
        let ampsData;
        let runTimeline;
        let runData = [
            [{ label: 'Date', type: 'string' }, { label: 'Pump', type: 'string' },
            { label: 'Start', type: 'date' }, { label: 'End', type: 'date' }]
        ];

        const sensor_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/data';
        const sms_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/sms';
        const amps_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/amps';

        // Returns a Bootstrap modal instance
        let modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('messageModal'))

        function getData(kind) {

            pumpUsed = {};
            ampsUsed = {};
            energyUsed = {};
            timelineUsed = {};
            infoData = "";
            ampsData = "";

            runData = [
                [{ label: 'Date', type: 'string' }, { label: 'Pump', type: 'string' },
                { label: 'Start', type: 'date' }, { label: 'End', type: 'date' }]
            ];

            // Creating Our XMLHttpRequest object
            let xhr = new XMLHttpRequest();
            let url;
            let dx;
            // Set url based on kind of data to retrieve
            if (kind === 'p') {
                url = sensor_url;
            } else if (kind === 'm') {
                url = sms_url;
            } else if (kind === 'a') {
                url = amps_url;
            }

            // Making our connection
            xhr.open("GET", url, true);

            // function will execute after request is successful
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    if (kind === 'p') {
                        formatData(this.responseText)
                        havePumpData = true;
                        buildTimelineData();
                        showG();
                        showRT();
                        infoTable();
                        dx = document.getElementById("gauges_div");
                        if (dx.style.display === "none") {
                            dx.style.display = "block";
                        }
                        dx = document.getElementById("run_div");
                        if (dx.style.display === "none") {
                            dx.style.display = "block";
                        }
                        document.getElementById("outputTable").innerHTML = "";

                        dx = document.getElementById("infoData_div");
                        if (dx.style.display === "none") {
                            dx.style.display = "block";
                        }

                        dx = document.getElementById("outputTable");
                        dx.style.display === "none"

                    } else if (kind === 'm') {
                        dx = document.getElementById("gauges_div");
                        if (dx.style.display === "block") {
                            dx.style.display = "none";
                        }
                        dx = document.getElementById("run_div");
                        if (dx.style.display === "block") {
                            dx.style.display = "none";
                        }
                        dx = document.getElementById("outputTable");
                        dx.style.display === "block"
                        formatSMS(this.responseText)
                    } else if (kind === 'a') {
                        formatAmps(this.responseText)
                    }
                }
            }
            // Sending our request
            xhr.send();
        }

        function buildTimelineData() {
            // console.log(JSON.stringify(data[i], null, 2))
            let g_sDate;
            let g_eDate
            let g_sHr;
            let g_eHr;
            let g_sMin;
            let g_eMin;
            let g_sSec;
            let g_eSec;
            let g_line;
            let g_sMM;
            let g_sDD;
            let g_sYY;
            let g_eMM;
            let g_eDD;
            let g_eYY;
            let dt;
            let tkeys;
            let tkey;
            let firstDay = "";

            tkeys = Object.keys(timelineUsed);
            tkeys = tkeys.sort();
            tkeys.reverse();

            for (let i = 0; i < tkeys.length; i++) {
                dt = timelineUsed[tkeys[i]].start_date.split("-")
                if (i === 0) {
                    firstDay = dt[0];
                    document.getElementById("gaugeDate").innerHTML = "High amps for " + firstDay;
                }
                // If the entry is for the first day get the high and low amps
                if (dt[0] === firstDay) {
                    if (timelineUsed[tkeys[i]].pump === "A") {
                        if (timelineUsed[tkeys[i]].amps_high > pumpA_amps_high) {
                            pumpA_amps_high = timelineUsed[tkeys[i]].amps_high;
                            pumpA_amps_entry = "Pump A high amps at: " + timelineUsed[tkeys[i]].start_date;
                        }
                    }
                    if (timelineUsed[tkeys[i]].pump === "B") {
                        if (timelineUsed[tkeys[i]].amps_high > pumpB_amps_high) {
                            pumpB_amps_high = timelineUsed[tkeys[i]].amps_high;
                            pumpB_amps_entry = "Pump B high amps at: " + timelineUsed[tkeys[i]].start_date;
                        }
                    }
                }

                // Start date info
                //dt = timelineUsed[tkeys[i]].start_date.split("-")
                g_sDate = dt[0];
                g_sMM = dt[0].substring(0, 2)
                g_sDD = dt[0].substring(3, 5)
                g_sYY = dt[0].substring(6)

                g_sHr = dt[1].substring(0, 2)
                g_sMin = dt[1].substring(3, 5)
                g_sSec = dt[1].substring(6)

                // End data info
                dt = timelineUsed[tkeys[i]].end_date.split("-")
                g_eDate = dt[0];

                if (g_sDate !== g_eDate) {
                    console.log("================")
                    console.log(JSON.stringify(timelineUsed[tkeys[i]], null, 2))
                    continue;
                }


                g_eMM = dt[0].substring(0, 2)
                g_eDD = dt[0].substring(3, 5)
                g_eYY = dt[0].substring(6)

                g_eHr = dt[1].substring(0, 2)
                g_eMin = dt[1].substring(3, 5)
                g_eSec = dt[1].substring(6)

                // Build the data for timeline chart
                g_line = [];
                g_line.push(g_sDate);
                g_line.push(timelineUsed[tkeys[i]].pump);
                // g_line.push(new Date(g_sYY, g_sMM, g_sDD, g_sHr, g_sMin, g_sSec))
                // g_line.push(new Date(g_eYY, g_eMM, g_eDD, g_eHr, g_eMin, g_eSec))
                g_line.push(new Date(0, 0, 0, g_sHr, g_sMin, g_sSec))
                g_line.push(new Date(0, 0, 0, g_eHr, g_eMin, g_eSec))
                // console.log(JSON.stringify(g_line, null, 2))
                runData.push(g_line)

            }
            //console.log(JSON.stringify(runData, null, 4))
            console.log("Timeline data created with " + runData.length + " entries")
            console.log("Pump A high amps " + pumpA_amps_high)
            console.log("Pump B high amps " + pumpB_amps_high)

            document.getElementById("entryA").innerHTML = pumpA_amps_entry;
            document.getElementById("entryB").innerHTML = pumpB_amps_entry;




            // ['06/27/23', 'A', new Date(0, 0, 0, 4, 7, 33), new Date(0, 0, 0, 4, 29, 0)],
        }


        function formatData(data) {
            let items = {};
            let days = "";
            let ampsHigh = "";
            let energy = "";
            let dt = [];
            let duration = 0;
            let highAmps = 0;
            let highEnergy = 0;
            let line;
            let day;
            let tKey;
            let dropNegCnt = 0;
            let dropInitialCnt = 0;
            let deleteArray = [];

            // convert data to JSON
            data = JSON.parse(data);

            // Loop through the returned rows of data    
            for (let i = 0; i < data.length; i++) {
                // Check for valid format of data
                if (typeof data[i].pump !== 'undefined') {

                    // Drop entries that are negative values or have initial value of 9999999
                    if (data[i].used_energy.startsWith("-")) {
                        //console.log('Dropped: ' + JSON.stringify(data[i], null, 4))
                        dropNegCnt++;
                        deleteArray.push('curl -X "DELETE" https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/data/' + data[i].id)
                        continue;
                    }
                    if (data[i].amps_low === "9999999" || data[i].amps_low === 9999999) {
                        //console.log('Dropped: ' + JSON.stringify(data[i], null, 4))
                        dropInitialCnt++;
                        deleteArray.push('curl -X "DELETE" https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/data/' + data[i].id)
                        continue;
                    }

                    // Get pump start_date and determine which period of the hour the pump started
                    dt = data[i].start_date.split("-")
                    if (typeof items[dt[0]] === 'undefined') {
                        items[dt[0]] = {}
                    }
                    // Add date to the days string if not already found
                    if (days.indexOf(dt[0]) === -1) {
                        days = days + dt[0] + "@"
                    }
                    // Get hour and minutes the pump started
                    hr = dt[1].substring(0, 2)
                    min = dt[1].substring(3, 5)

                    period = 1
                    if (min > 15 && min < 31) {
                        period = 2
                    } else if (min > 30 && min < 46) {
                        period = 3
                    } else if (min > 45 && min < 60) {
                        period = 4
                    }

                    // Save the pump data for use in other portions of the UI
                    key = hr + "." + period
                    items[dt[0]][key] = data[i].pump
                    key = dt[0] + "." + key
                    pumpUsed[key] = data[i]

                    // Save data for timeline chart/graph
                    tKey = data[i].start_date;
                    timelineUsed[tKey] = data[i]

                    // Save energy used
                    energy = energy + data[i].used_energy + "#" + key + "@"
                    if (data[i].used_energy > highEnergy) {
                        highEnergy = data[i].used_energy;
                    }

                    // Save amps high
                    ampsHigh = ampsHigh + padZ(data[i].amps_high) + "#" + key + "@"
                    if (data[i].amps_high > highAmps) {
                        highAmps = data[i].amps_high;
                    }

                } else {
                    // Output the curl command to delete the item that contains improperly formatted data
                    console.log('curl -X "DELETE" https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/data/' + data[i].id)
                }
            }

            console.log("Dropped because of negative value: " + dropNegCnt)
            console.log("Dropped because of initial value: " + dropInitialCnt)
            console.log(JSON.stringify(deleteArray, null, 2))

        }


        // function buildEnergyUsed(data, high, energyKeys) {
        //     let keys = energyKeys.split("@");
        //     let h = "<div style='margin-top: 15px;'> <hr></div> <div style='margin-top: 15px; margin-bottom: 5px;'>" +
        //         '<h5>Duration and energy usage for each time a pump was active</h5>' +
        //         '<div style="margin: 15px;"><p>Each bar has the pump "A" or "B" with the date and time along with ' +
        //         'energy "E:" and duration "D:". Click any of the color bars to view detail information.</p></div>';
        //     let pct = 0;
        //     let parts;
        //     let factor = 5;
        //     let color;
        //     let textColor;
        //     let info;
        //     let energy;
        //     let dur;
        //     let sDate;

        //     keys = keys.sort();
        //     let hl = keys.length - 1;

        //     for (let k = hl; k > 0; k--) {
        //         if (typeof keys[k] !== 'undefined') {
        //             if (keys[k].indexOf("#") !== -1) {
        //                 parts = keys[k].split("#");
        //                 energy = parts[0];
        //                 pct = Math.round(energy / factor)
        //                 info = pumpUsed[parts[1]];
        //                 color = "black";
        //                 textColor = "white"
        //                 if (info.pump === "A") {
        //                     color = "blue";
        //                 } else if (info.pump === "B") {
        //                     color = "green";
        //                 }
        //                 if (energy < 1) {
        //                     color = "yellow";
        //                     textColor = "black";
        //                     pct = 20;
        //                     dur = ''
        //                 } else {
        //                     dur = ', D: ' + calcInformation(info)
        //                 }
        //                 sDate = info.start_date.substring(0, 5) + "-" + info.start_date.substring(11, 16)
        //                 h = h + '<div style="margin: 2px; border: 0px solid #ccc;">' +
        //                     '<div style="background-color: ' + color + ';' +
        //                     ' height:15px; ' +
        //                     ' width:' + pct + '%; ' +
        //                     ' text-align: right; ' +
        //                     ' font-size: 10px;' +
        //                     ' color: ' + textColor + ';' +
        //                     ' pad-right: 5px;' +
        //                     ' "' +
        //                     'onclick="pumpUsage(\'' + parts[1] + '\')">' +
        //                     '(' + info.pump + ') ' + sDate +
        //                     ', E: ' + energy +
        //                     dur +
        //                     '&nbsp;</div></div>';
        //             }
        //         }
        //     }
        //     h = h + "<div style='margin-top: 15px;'> <hr></div>";
        //     return h;
        // }

        // function buildAmpsUsed(data, high, ampKeys) {
        //     let keys = ampKeys.split("@");
        //     let factor = Math.round(high / 100);
        //     let h = "<div style='margin-top: 15px;'> <hr></div> <div style='margin-top: 15px; margin-bottom: 5px;'>" +
        //         '<h5>High level amps for each time a pump was active.</h5> ' +
        //         '<div style="margin: 15px;"><p>Each bar has the pump "A" or "B" with the date and time along with ' +
        //         'amps. Click any of the color bars to view detail information.</p></div>';
        //     let pct = 0;
        //     let parts;
        //     let color;
        //     let textColor;
        //     let info;
        //     let amps;
        //     let sDate;

        //     keys = keys.sort();
        //     let hl = keys.length - 1;

        //     for (let k = hl; k > 0; k--) {
        //         if (typeof keys[k] !== 'undefined') {
        //             if (keys[k].indexOf("#") !== -1) {
        //                 parts = keys[k].split("#");
        //                 amps = parts[0];
        //                 pct = Math.round(amps / factor)
        //                 info = pumpUsed[parts[1]];
        //                 color = "black";
        //                 textColor = "white";
        //                 if (info.pump === "A") {
        //                     color = "blue";
        //                 } else if (info.pump === "B") {
        //                     color = "green";
        //                 }
        //                 let pAmps = roundTo(amps / 1000, 2);
        //                 if (pAmps < 1) {
        //                     pct = 20;
        //                     color = "yellow";
        //                     textColor = "black";
        //                 }
        //                 sDate = info.start_date.substring(0, 5) + "-" + info.start_date.substring(11, 16)

        //                 h = h + '<div style="margin: 2px; border: 0px solid #ccc;">' +
        //                     '<div style="background-color: ' + color + ';' +
        //                     ' height: 15px; ' +
        //                     ' width:' + pct + '%; ' +
        //                     ' text-align: right; ' +
        //                     ' font-size: 10px;' +
        //                     ' color: ' + textColor + ';' +
        //                     ' pad-right: 5px;' +
        //                     ' "' +
        //                     ' onclick="pumpUsage(\'' + parts[1] + '\')" >' +
        //                     '(' + info.pump + ') ' + sDate +
        //                     ', Amps: ' + pAmps +
        //                     '&nbsp;</div></div>';

        //             }
        //         }
        //     }
        //     return h;
        // }

        function pumpUsage(key) {
            let kp = key.split('.')
            let data = pumpUsed[key]
            if (typeof data.start_date === 'undefined') {
                alert('Did not find data for key: ' + key)
                return;
            }
            //alert(JSON.stringify(data, null, 2))
            let duration = calcInformation(data)
            let low = data.amps_low / 1000
            low = roundTo(low, 3)
            let high = data.amps_high / 1000
            high = roundTo(high, 3)
            let avg = data.amps_avg / 1000
            avg = roundTo(avg, 3)

            let h = '<table cellpadding="2" cellspacing="0" width="100%" border="0" >' +
                '<thead><tr>' +
                '<th style="text-align: center" bgcolor="#eee">Data</th>' +
                '<th style="text-align: center" bgcolor="#eee">Value</th>' +
                '</tr></thead><tbody>' +
                '<tr><td style="font-size: 80%;">Pump</td><td>' + data.pump +
                '</tr><tr><td style="font-size: 80%;">Start date & time</td><td>' + data.start_date +
                '</tr><tr><td style="font-size: 80%;">End date & time</td><td>' + data.end_date +
                '</tr><tr><td style="font-size: 80%;">Run duration (MM:SS)</td><td>' + duration +
                '</tr><tr><td style="font-size: 80%;">Start energy</td><td>' + data.start_energy +
                '</tr><tr><td style="font-size: 80%;">End energy</td><td>' + data.end_energy +
                '</tr><tr><td style="font-size: 80%;">Used energy</td><td>' + data.used_energy +
                '</tr><tr><td style="font-size: 80%;">Amps low</td><td>' + low +
                '</tr><tr><td style="font-size: 80%;">Amps average</td><td>' + avg +
                '</tr><tr><td style="font-size: 80%;">Amps high</td><td>' + high +
                '</tr></table>'
            document.getElementById("messageBody").innerHTML = h;
            modal.show();
        }

        function closeModal() {
            modal.hide();
        }

        function roundTo(n, place) {
            return +(Math.round(n + "e+" + place) + "e-" + place);
        }

        function formatSMS(data) {
            let sData = [];
            let r = "";
            let h = "";
            // convert data to JSON
            data = JSON.parse(data);
            for (let i = 0; i < data.length; i++) {
                sData.push(data[i].id + "#" + data[i].date + "#" + data[i].message + "#" + data[i].who)
            }
            data = null;
            // Sort data
            sData.sort();
            // build the new outputTable
            cnt = 0;
            h = '<h5>SMS messages sent</h5>' +
                '<table class="table table-striped"><thead><tr>' +
                '<th scope="col">Date/Time</th>' +
                '<th scope="col">Message</th>' +
                '<th scope="col">Sent To</th>' +
                '</tr></thead><tbody>'
            // Rows of requested data    
            for (let i = 0; i < sData.length; i++) {
                r = "";
                parts = sData[i].split("#");
                if (parts.length === 4) {
                    r = '<tr>' +
                        '<td>' + parts[1] + '</td>' +
                        '<td>' + parts[2] + '</td>' +
                        '<td>' + parts[3] + '</td>'
                    '</tr>'
                    cnt++
                    h = h + r;
                }
            }

            // If no data inserted in table add this message
            if (cnt === 0) {
                h = h + '<tr><td>No data available</td></tr>'
            }
            // Close the table
            h = h + '</tbody></table>'

            // clear outputTable in the html page
            document.getElementById("outputTable").innerHTML = ""
            // Add html to page
            document.getElementById("outputTable").innerHTML = h;

            h = null;
            sData = []
        }

        function calcInformation(data) {
            tmpS = data.start_date.split("-");
            start = convertToSeconds(tmpS[1])
            tmpE = data.end_date.split("-");
            end = convertToSeconds(tmpE[1])
            if (start === 99999999 || end === 99999999) {
                return "Unknown"
            }
            // Check if start and end date are different
            if (tmpS[0] !== tmpE[0]) {
                seconds = 86400 - start
                return convertToMinutes(seconds + end)
            } else {
                seconds = end - start;
                return convertToMinutes(seconds)
            }
        }

        function convertToMinutes(s) {
            min = s / 60
            min = parseInt(min, 10)
            sec = s % 60
            if (sec === 00) {
                sec = '00'
            }
            if (sec < 10) {
                sec = "0" + sec
            }
            if (min < 10) {
                min = "0" + min
            }
            return min + ":" + sec
        }

        function convertToSeconds(time) {
            t = time.split(":");
            hrs = parseInt(t[0], 10) * 3600
            if (isNaN(hrs)) {
                return 99999999
            }
            mins = parseInt(t[1], 10) * 60
            if (isNaN(mins)) {
                return 99999999
            }
            secs = parseInt(t[2], 10)
            if (isNaN(secs)) {
                return 99999999
            }
            return hrs + mins + secs
        }

        function padZ(v) {
            if (v < 100) {
                return "0000" + v;
            } else if (v < 1000) {
                return "000" + v;
            } else if (v < 1000) {
                return "00" + v;
            } else if (v < 10000) {
                return "0" + v;
            } else {
                return v;
            }
        }

        function showG() {
            // GAUGES
            var ampsGauge;
            var aH = 0;
            var bH = 0;
            if (pumpA_amps_high > 0) {
                aH = pumpA_amps_high / 1000;
            }
            if (pumpB_amps_high > 0) {
                bH = pumpB_amps_high / 1000;
            }
            ampsData = [
                ['Label', 'Value'],
                ['Pump A', aH],
                ['Pump B', bH]
            ];
            google.charts.load('current', { 'packages': ['gauge'] });
            google.charts.setOnLoadCallback(drawAmpsGauges);
        }

        function showRT() {
            if (havePumpData === false) {
                getData('p');
            }
            // RUN TIMES
            google.charts.load("current", { packages: ["timeline"] });
            google.charts.setOnLoadCallback(drawRunTimeline);
        }



        // Exammple data
        // var runData = [
        //     [{ label: 'Date', type: 'string' }, { label: 'Pump', type: 'string' },
        //     { label: 'Start', type: 'date' }, { label: 'End', type: 'date' }],
        //     ['06/27/23', 'A', new Date(0, 0, 0, 4, 7, 33), new Date(0, 0, 0, 4, 29, 0)],
        // ];

        //=====================================
        function drawAmpsGauges() {
            var options = {
                width: 400, height: 120,
                greenFrom: 10, greenTo: 28,
                yellowFrom: 28, yellowTo: 35,
                redFrom: 35, redTo: 40,
                minorTicks: 10,
                majorTicks: [0, 10, 20, 30, 40],
                min: 0,
                max: 40,
                height: 200,
                width: 400,
                greenColor: "#00cc00",
                yellowColor: "#ffdd00",
                redColor: "#ff0000"
            };

            var chart = new google.visualization.Gauge(document.getElementById('chart_div'));
            ampsGauge = google.visualization.arrayToDataTable(ampsData);
            chart.draw(ampsGauge, options);
        }


        function drawRunTimeline() {
            var container = document.getElementById('run_time');
            var options = {
                colors: ['#f99', '#f99'],
                tooltip: { trigger: 'none' }
            };

            // tooltip: { trigger: 'none' }

            tline = new google.visualization.Timeline(container);
            // Add our selection handler.
            google.visualization.events.addListener(tline, 'select', tlineHandler);

            dataTable = google.visualization.arrayToDataTable(runData);
            tline.draw(dataTable, options);
        }


        // Selection handler for time line chart
        // Loop through all items in the selection and concatenate
        // a single message from all of them.
        function tlineHandler() {
            var selection = tline.getSelection();
            var message = '';
            var period;
            var item;
            var p;
            var data;
            var sTime;
            var strTime;
            var hh;
            var mm;
            var i;
            var key;

            //alert('You clicked something')
            for (i = 0; i < selection.length; i++) {
                item = selection[i];
                p = item.row;
                console.log("p: " + p)
                p = p + 1;
                data = runData[p];
                sTime = data[2];

                strTime = sTime.toTimeString()
                hh = strTime.substring(0, 2);
                mm = strTime.substring(3, 5);

                period = 1;
                if (mm > 15 && mm < 31) {
                    period = 2
                }
                if (mm > 30 && mm < 46) {
                    period = 3
                }
                if (mm > 45) {
                    period = 4
                }
                key = data[0] + "." + hh + "." + period

                pumpUsage(key)

            }
        }

        function infoTable() {

            infoData = [
                ['Name', 'Amount'],
                ['Mike', { v: 10000, f: '$10,000' }],
                ['Jim', { v: 8000, f: '$8,000' }],
                ['Alice', { v: 12500, f: '$12,500' }],
                ['Bob', { v: 7000, f: '$7,000' }]
            ];


            google.charts.load('current', { 'packages': ['table'] });
            google.charts.setOnLoadCallback(drawInfoTable);
        }

        function drawInfoTable() {
            data = new google.visualization.arrayToDataTable(infoData);
            var table = new google.visualization.Table(document.getElementById('info_div'));

            table.draw(data, { showRowNumber: true, width: '100%', height: '100%' });
        }

    </script>

</body>

</html>