<!DOCTYPE html>
<html lang="en">

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MMPOAII</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <style>
        table {
            border-collapse: collapse;
        }

        td,
        th {
            border-left: 1px solid #bbb;
            border-right: 1px solid #bbb;
            border-bottom: 1px solid #555;
            border-top: 1px solid #555;
        }
    </style>

</head>

<body>
    <div class="container">
        <header
            class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <span class="fs-4">MMPOA-II</span>
            </a>

            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-outline-primary me-2" onclick="getData('p')">Pump
                    Energy</button>
                <button type="button" class="btn btn-outline-primary" onclick="getData('m')">SMS Messages</button>
            </div>
        </header>

        <div id="outputTable">
            <div style="margin: 20px;">
                <h5>Press one of the above buttons to populate available information.</h5>
            </div>
            <!-- Data is inserted here -->
        </div>

        <!-- ==================================== -->
        <!-- Message Modal section                -->
        <!-- ==================================== -->
        <div class="modal fade" id="messageModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Detail pump information for selected entry</h5>
                    </div>
                    <div class="modal-body docBackground">
                        <div id="messageBody">
                            <!-- Data is inserted here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeModal()" type="button" class="btn btn-secondary" data-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts to populate the UI and retirieve data-->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous">
        </script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
        </script>

    <script>
        let pumpUsed = {};
        let ampsUsed = {};
        let energyUsed = {};

        const sensor_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/data';
        const sms_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/sms';
        const amps_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/amps';

        // Returns a Bootstrap modal instance
        let modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('messageModal'))

        function getData(kind) {
            // Creating Our XMLHttpRequest object
            let xhr = new XMLHttpRequest();
            let url;

            // Set url based on kind of data to retrieve
            if (kind === 'p') {
                url = sensor_url;
            } else if (kind === 'm') {
                url = sms_url;
            } else if (kind === 'a') {
                url = amps_url;
            }

            // Making our connection
            xhr.open("GET", url, true);

            // function will execute after request is successful
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    if (kind === 'p') {
                        formatData(this.responseText)
                    } else if (kind === 'm') {
                        formatSMS(this.responseText)
                    } else if (kind === 'a') {
                        formatAmps(this.responseText)
                    }
                }
            }
            // Sending our request
            xhr.send();
        }


        function formatData(data) {
            let items = {};
            let days = "";
            let ampsHigh = "";
            let energy = "";
            let dt = [];
            let duration = 0;
            let highAmps = 0;
            let highEnergy = 0;
            let line;
            let day;

            // convert data to JSON
            data = JSON.parse(data);

            //console.log(JSON.stringify(data, null, 4))

            // Rows of requested data    
            for (let i = 0; i < data.length; i++) {
                // Check for valid format of data
                if (typeof data[i].pump !== 'undefined') {

                    // Drop entries that are negative values or have initial value
                    if (data[i].used_energy.startsWith("-")) {
                        console.log('Dropped: ' + JSON.stringify(data[i], null, 4))
                        continue;
                    }
                    if (data[i].amps_low === "9999999" || data[i].amps_low === 9999999) {
                        console.log('Dropped: ' + JSON.stringify(data[i], null, 4))
                        continue;
                    }

                    // Get pump start_date and determine which period of the hour the pump started
                    dt = data[i].start_date.split("-")
                    if (typeof items[dt[0]] === 'undefined') {
                        items[dt[0]] = {}
                    }
                    // Add date to the days string if not already found
                    if (days.indexOf(dt[0]) === -1) {
                        days = days + dt[0] + "@"
                    }
                    // Get hour and minutes the pump started
                    hr = dt[1].substring(0, 2)
                    min = dt[1].substring(3, 5)
                    period = 1
                    if (min > 15 && min < 31) {
                        period = 2
                    } else if (min > 30 && min < 46) {
                        period = 3
                    } else if (min > 45 && min < 60) {
                        period = 4
                    }

                    // Save the pump data for use in other portions of the UI
                    key = hr + "." + period
                    items[dt[0]][key] = data[i].pump
                    key = dt[0] + "." + key
                    pumpUsed[key] = data[i]

                    // Save energy used
                    energy = energy + data[i].used_energy + "#" + key + "@"
                    if (data[i].used_energy > highEnergy) {
                        highEnergy = data[i].used_energy;
                    }

                    // Save amps high
                    ampsHigh = ampsHigh + padZ(data[i].amps_high) + "#" + key + "@"
                    if (data[i].amps_high > highAmps) {
                        highAmps = data[i].amps_high;
                    }

                } else {
                    // Output the curl command to delete the item that contains improperly formatted data
                    console.log('curl -X "DELETE" https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/data/' + data[i].id)
                }
            }

            // Split and sort the days that information has been reported
            da = days.split("@");
            da = da.sort();

            // build the new outputTable with the pump information
            h = '<h5>Pump activity by day and hour segements </h5>' +
                '<div style="margin: 15px;"><p>' +
                'The table below displays dates along with hourly intervals based on a 24 hour clock with midnight being 00. ' +
                'Each hour is reported with four 15 minute periods. ' +
                'The pump start time is used to place the pump activity in the respective 15 minute period. ' +
                'The pump id "A" (pump 1) or id "B" (pump 2) is shown in the reported period. ' +
                'Click on the colored pump id to view the detail for that pump cycle period. ' +
                '</p></div>' +
                '<table cellpadding="0" cellspacing="0" width="100%" border="0"><thead><tr>' +
                '<th style="text-align: center">Date & Hr</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">00</th>' +
                '<th style="text-align: center" colspan="4" >01</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">02</th>' +
                '<th style="text-align: center" colspan="4" >03</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">04</th>' +
                '<th style="text-align: center" colspan="4" >05</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">06</th>' +
                '<th style="text-align: center" colspan="4" >07</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">08</th>' +
                '<th style="text-align: center" colspan="4" >09</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">10</th>' +
                '<th style="text-align: center" colspan="4" >11</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">12</th>' +
                '<th style="text-align: center" colspan="4" >13</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">14</th>' +
                '<th style="text-align: center" colspan="4" >15</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">16</th>' +
                '<th style="text-align: center" colspan="4" >17</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">18</th>' +
                '<th style="text-align: center" colspan="4" >19</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">20</th>' +
                '<th style="text-align: center" colspan="4" >21</th>' +
                '<th style="text-align: center" colspan="4" bgcolor="#eee">22</th>' +
                '<th style="text-align: center" colspan="4" >23</th>' +
                '</tr></thead><tbody>';

            // Output data for each day of information  
            for (let i = 1; i < da.length; i++) {
                line = "<tr><td>&nbsp;" + da[i] + "&nbsp;</td>";
                day = items[da[i]]
                let hkey;
                // Check for each hour of the day 
                for (let hr = 0; hr < 24; hr++) {
                    // Check for each period of the hour
                    for (let p = 1; p < 5; p++) {
                        if (hr < 10) {
                            hkey = "0" + hr
                        } else {
                            hkey = hr
                        }
                        key = hkey + "." + p
                        // If pump ran in this hour-period show letter of Pump
                        if (typeof day[key] !== 'undefined') {
                            if (day[key] === "A") {
                                style = "text-align: center"
                                line = line + "<td onclick='pumpUsage(\"" + da[i] + "." + key + "\")' style='text-align: center; color: white' bgcolor='blue' width='1%'>" + day[key] + "</td>"
                            } else {
                                line = line + "<td onclick='pumpUsage(\"" + da[i] + "." + key + "\")' style='text-align: center; color: white' bgcolor='green' width='1%'>" + day[key] + "</td>"
                            }
                        } else {
                            if (hr === 0 || hr === 2 || hr === 4 || hr === 6 || hr === 8 || hr === 10 || hr === 12 || hr === 14 || hr === 16 || hr === 18 || hr === 20 || hr === 22) {
                                line = line + "<td bgcolor='#eee' width='1%'></td>"
                            } else {
                                line = line + "<td width='1%'></td>"
                            }
                        }
                    }
                }
                // Close the row and append to the html
                line = line + "</tr>"
                h = h + line
            }

            // Close the table
            h = h + '</tbody></table>'

            let aH = buildAmpsUsed(data, highAmps, ampsHigh)
            h = h + aH;

            let eH = buildEnergyUsed(data, highEnergy, energy)
            h = h + eH;

            // Clear any existing data in the UI
            document.getElementById("outputTable").innerHTML = ""
            // Add new html to page
            document.getElementById("outputTable").innerHTML = h;
        }


        function buildEnergyUsed(data, high, energyKeys) {
            let keys = energyKeys.split("@");
            keys = keys.sort()
            let h = "<div style='margin-top: 15px;'> <hr></div> <div style='margin-top: 15px; margin-bottom: 5px;'>" +
                '<h5>Energy usage for each time a pump was active</h5>' +
                '<div style="margin: 15px;"><p>Click any of the colored bars to view detail information.</p></div>';
            let pct = 0;
            let parts;
            let factor = 5;
            let colored;
            let info;
            let energy;
            for (let k = 1; k <= keys.length; k++) {
                if (typeof keys[k] !== 'undefined') {
                    if (keys[k].indexOf("#") !== -1) {
                        parts = keys[k].split("#");
                        energy = parts[0];
                        pct = Math.round(energy / factor)
                        info = pumpUsed[parts[1]];
                        color = "light-grey";
                        if (info.pump === "A") {
                            color = "blue";
                        } else if (info.pump === "B") {
                            color = "green";
                        }
                        h = h + '<div style="margin: 2px; border: 0px solid #ccc;">' +
                            //'<div>' + parts[0] + '</div>' +
                            '<div style="background-color: ' + color + '; height:15px; width:' + pct + '%;" ' +
                            'onclick="pumpUsage(\'' + parts[1] + '\')"></div></div>';
                    }
                }
            }
            h = h + "<div style='margin-top: 15px;'> <hr></div>";
            return h;
        }


        function buildAmpsUsed(data, high, ampKeys) {
            let keys = ampKeys.split("@");

            keys = keys.sort();
            let hAmp = roundTo(high / 1000, 2);
            let factor = Math.round(high / 100);
            let h = "<div style='margin-top: 15px;'> <hr></div> <div style='margin-top: 15px; margin-bottom: 5px;'>" +
                '<h5>High level amps for each time a pump was active.  Highest overall amps were: ' + hAmp + '</h5> ' +
                '<div style="margin: 15px;"><p>Click any of the colored bars to view detail information.</p></div>';
            let pct = 0;
            let parts;
            let colored;
            let info;
            let amps;
            for (let k = 1; k <= keys.length; k++) {
                if (typeof keys[k] !== 'undefined') {
                    if (keys[k].indexOf("#") !== -1) {
                        parts = keys[k].split("#");
                        amps = parts[0];
                        pct = Math.round(amps / factor)
                        info = pumpUsed[parts[1]];
                        color = "light-grey";
                        if (info.pump === "A") {
                            color = "blue";
                        } else if (info.pump === "B") {
                            color = "green";
                        }
                        h = h + '<div style="margin: 2px; border: 0px solid #ccc;">' +
                            //'<div>' + parts[0] + '</div>' +
                            '<div style="background-color: ' + color + '; height:15px; width:' + pct + '%;" ' +
                            'onclick="pumpUsage(\'' + parts[1] + '\')"></div></div>';
                    }
                }
            }
            return h;
        }


        function pumpUsage(key) {
            let kp = key.split('.')
            let data = pumpUsed[key]
            //alert(JSON.stringify(data, null, 2))
            let duration = calcInformation(data)
            let low = data.amps_low / 1000
            low = roundTo(low, 3)
            let high = data.amps_high / 1000
            high = roundTo(high, 3)
            let avg = data.amps_avg / 1000
            avg = roundTo(avg, 3)

            let h = '<h6>Entry - &nbsp;&nbsp;Day: ' + kp[0] + '&nbsp;&nbsp;&nbsp;Hour: ' + kp[1] + '&nbsp;&nbsp;&nbsp;Period: ' + kp[2] + '</h6>' +
                '<table cellpadding="2" cellspacing="0" width="100%" border="0" >' +
                '<thead><tr>' +
                '<th style="text-align: center" bgcolor="#eee">Data</th>' +
                '<th style="text-align: center" bgcolor="#eee">Value</th>' +
                '</tr></thead><tbody>' +
                '<tr><td>Pump</td><td>' + data.pump +
                '</tr><tr><td>Start date & time</td><td>' + data.start_date +
                '</tr><tr><td>End date & time</td><td>' + data.end_date +
                '</tr><tr><td>Run duration (MM:SS)</td><td>' + duration +
                '</tr><tr><td>Start energy</td><td>' + data.start_energy +
                '</tr><tr><td>End energy</td><td>' + data.end_energy +
                '</tr><tr><td>Used energy</td><td>' + data.used_energy +
                '</tr><tr><td>Amps low</td><td>' + low +
                '</tr><tr><td>Amps average</td><td>' + avg +
                '</tr><tr><td>Amps high</td><td>' + high +
                '</tr></table>'
            document.getElementById("messageBody").innerHTML = h;
            modal.show();
        }

        function closeModal() {
            modal.hide();
        }

        function roundTo(n, place) {
            return +(Math.round(n + "e+" + place) + "e-" + place);
        }

        function formatSMS(data) {
            let sData = [];
            let r = "";
            let h = "";
            // convert data to JSON
            data = JSON.parse(data);
            for (let i = 0; i < data.length; i++) {
                sData.push(data[i].id + "#" + data[i].date + "#" + data[i].message + "#" + data[i].who)
            }
            data = null;
            // Sort data
            sData.sort();
            // build the new outputTable
            cnt = 0;
            h = '<h5>SMS messages sent</h5>' +
                '<table class="table table-striped"><thead><tr>' +
                '<th scope="col">Date/Time</th>' +
                '<th scope="col">Message</th>' +
                '<th scope="col">Sent To</th>' +
                '</tr></thead><tbody>'
            // Rows of requested data    
            for (let i = 0; i < sData.length; i++) {
                r = "";
                parts = sData[i].split("#");
                if (parts.length === 4) {
                    r = '<tr>' +
                        '<td>' + parts[1] + '</td>' +
                        '<td>' + parts[2] + '</td>' +
                        '<td>' + parts[3] + '</td>'
                    '</tr>'
                    cnt++
                    h = h + r;
                }
            }

            // If no data inserted in table add this message
            if (cnt === 0) {
                h = h + '<tr><td>No data available</td></tr>'
            }
            // Close the table
            h = h + '</tbody></table>'

            // clear outputTable in the html page
            document.getElementById("outputTable").innerHTML = ""
            // Add html to page
            document.getElementById("outputTable").innerHTML = h;

            h = null;
            sData = []
        }


        function calcInformation(data) {
            tmpS = data.start_date.split("-");
            start = convertToSeconds(tmpS[1])
            tmpE = data.end_date.split("-");
            end = convertToSeconds(tmpE[1])
            if (start === 99999999 || end === 99999999) {
                return "Unknown"
            }
            // Check if start and end date are different
            if (tmpS[0] !== tmpE[0]) {
                seconds = 86400 - start
                return convertToMinutes(seconds + end)
            } else {
                seconds = end - start;
                return convertToMinutes(seconds)
            }
        }

        function convertToMinutes(s) {
            min = s / 60
            min = parseInt(min, 10)
            sec = s % 60
            if (sec === 00) {
                sec = '00'
            }
            if (sec < 10) {
                sec = "0" + sec
            }
            if (min < 10) {
                min = "0" + min
            }
            return min + ":" + sec
        }

        function convertToSeconds(time) {
            t = time.split(":");
            hrs = parseInt(t[0], 10) * 3600
            if (isNaN(hrs)) {
                return 99999999
            }
            mins = parseInt(t[1], 10) * 60
            if (isNaN(mins)) {
                return 99999999
            }
            secs = parseInt(t[2], 10)
            if (isNaN(secs)) {
                return 99999999
            }
            return hrs + mins + secs
        }

        function padZ(v) {
            if (v < 100) {
                return "0000" + v;
            } else if (v < 1000) {
                return "000" + v;
            } else if (v < 1000) {
                return "00" + v;
            } else if (v < 10000) {
                return "0" + v;
            } else {
                return v;
            }
        }

    </script>
</body>

</html>