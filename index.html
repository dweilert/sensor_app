<!DOCTYPE html>
<html lang="en">

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MMPOAII</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>

<body>

    <div class="container">
        <header
            class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <svg class="bi me-2" width="40" height="32">
                    <use xlink:href="#bootstrap" />
                </svg>
                <span class="fs-4">MMPOAII</span>
            </a>

            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-outline-primary me-2" onclick="getData('p')">Pump
                    Energy</button>
                <button type="button" class="btn btn-outline-primary" onclick="getData('m')">SMS Messages</button>
            </div>
        </header>

        <div id="outputTable">

        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous">
        </script>
    <script>
        function getData(kind) {
            // Creating Our XMLHttpRequest object
            var xhr = new XMLHttpRequest();

            // Making our connection
            var sensor_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/data';
            var sms_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/sms';
            var amps_url = 'https://isf1iqwwv2.execute-api.us-east-2.amazonaws.com/amps';

            if (kind === 's') {
                url = sensor_url
            } else if (kind === 'm') {
                url = sms_url
            } else if (kind === 'a') {
                url = amps_url
            }



            xhr.open("GET", url, true);

            // function execute after request is successful
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    //console.log(this.responseText);
                    formatData(this.responseText, kind)
                }

            }
            // Sending our request
            xhr.send();
        }

        function formatData(data, kind) {
            // convert data to JSON
            data = JSON.parse(data);
            console.log(JSON.stringify(data, null, 2))
            // clear outputTable in the html page
            document.getElementById("outputTable").innerHTML = ""
            // build the new outputTable
            cnt = 0;
            h = ''
            // Output type
            if (kind === 'p') {
                h = '<h5>Pump energy usage</h5>'
            } else {
                h = '<h5>SMS messaes sent</h5>'
            }
            // Table headers
            h = h + "<table class='table table-striped'><thead><tr>";
            if (kind === 'p') {
                h = h +
                    '<th scope="col">Pump</th>' +
                    '<th scope="col">Start date/time</th>' +
                    '<th scope="col">End date/time</th>' +
                    '<th scope="col">Duration<br>(mm:ss) </th>' +
                    '<th scope="col">Energy<br>Used</th>'
            } else {
                h = h +
                    '<th scope="col">Date/Time</th>' +
                    '<th scope="col">Who</th>' +
                    '<th scope="col">Message</th>'
            }
            h = h + '</tr></thead><tbody>'
            // Rows of requested data    
            for (let i = 0; i < data.length; i++) {
                r = ''
                //console.log(typeof (data[i]))
                //console.log(data[i])
                if (kind === 'p') {
                    if (typeof data[i].pump !== 'undefined') {
                        duration = calcInformation(data[i])
                        r = '<tr>' +
                            '<td>' + data[i].pump + '</td>' +
                            '<td>' + data[i].start_date + '</td>' +
                            '<td>' + data[i].end_date + '</td>' +
                            '<td>' + duration + '</td>' +
                            '<td>' + data[i].used_energy + '</td>' +
                            '</tr>'
                        cnt++;
                        h = h + r;
                    }
                } else {
                    if (typeof data[i].message !== 'undefined') {
                        r = '<tr>' +
                            '<td>' + data[i].date + '</td>' +
                            '<td>' + data[i].who + '</td>' +
                            '<td>' + data[i].message + '</td>'
                        '</tr>'
                        cnt++
                        h = h + r;
                    }
                }
            }
            // If no data inserted in table add this message
            if (cnt === 0) {
                h = h + '<tr><td>No data available</td></tr>'
            }
            // Close the table
            h = h + '</tbody></table>'
            // Add html to page
            document.getElementById("outputTable").innerHTML = h;
        }

        function calcInformation(data) {
            tmpS = data.start_date.split("-");
            start = convertToSeconds(tmpS[1])
            tmpE = data.end_date.split("-");
            end = convertToSeconds(tmpE[1])
            if (start === 99999999 || end === 99999999) {
                return "Unknown"
            }
            // Check if start and end date are different
            if (tmpS[0] !== tmpE[0]) {
                seconds = 86400 - start
                return convertToMinutes(seconds + end)
            } else {
                seconds = end - start;
                return convertToMinutes(seconds)
            }
        }

        function convertToMinutes(s) {
            min = s / 60
            min = parseInt(min, 10)
            sec = s % 60
            if (sec === 00) {
                sec = '00'
            }
            return min + ":" + sec
        }

        function convertToSeconds(time) {
            t = time.split(":");
            hrs = parseInt(t[0], 10) * 3600
            if (isNaN(hrs)) {
                return 99999999
            }
            mins = parseInt(t[1], 10) * 60
            if (isNaN(mins)) {
                return 99999999
            }
            secs = parseInt(t[2], 10)
            if (isNaN(secs)) {
                return 99999999
            }
            return hrs + mins + secs
        }
    </script>
</body>

</html>